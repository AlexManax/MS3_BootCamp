pipeline {
  agent none
  stages {
    stage('Package JAR') {
      agent {
        docker {
          image 'maven:3-jdk-8'
          args '-v $HOME/.m2:/root/.m2'
        }

      }
      steps {
        sh 'mvn clean package'
        stash(name: 'MS3_BootCamp-1.0-SNAPSHOT', includes: 'target/*.jar')
      }
    }
    stage('Build & Deploy') {
      agent {
        docker {
          image 'docker/compose:1.9.0'
        }
      }
      steps {
        unstash 'MS3_BootCamp-1.0-SNAPSHOT.jar'
        sh 'docker-compose up --build -d'
        sh 'docker system prune -f'
      }
    }
  }
}
